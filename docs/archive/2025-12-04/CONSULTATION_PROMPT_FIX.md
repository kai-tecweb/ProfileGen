# 相談チャット機能 プロンプト修正レポート

修正日時: 2025年12月4日

## 問題点

1. **4段階構造になっていない**: LLMが指示を無視して、4段階構造で回答しない場合があった
2. **ナレッジに無い質問への対応が不明確**: 記事知識に関連する情報がない場合の対応が明示されていなかった

## 修正内容

### 修正前の問題点

- 4段階形式の指示が質問の後に配置されていた
- 指示が弱く、LLMが無視しやすい構造
- ナレッジに無い質問への対応が明示されていなかった

### 修正後の改善点

1. **【絶対に守るべきルール】を最初に配置**
   - 4段階構造の指示をプロンプトの最初に配置
   - 「必ず」という強い指示を明確化

2. **【回答フォーマット】を具体的に提示**
   - 各セクションの見出しを明示
   - 箇条書きの例を具体的に提示

3. **ナレッジに無い質問への対応を明示**
   - 「記事知識には該当する情報がありませんでした」と明記するよう指示
   - 一般的な知識で回答するよう指示

4. **プロンプトの構造を整理**
   - ルール → フォーマット → 知識 → 質問の順に整理
   - セクション間を「---」で区切り、視覚的に分離

## 修正後のプロンプト構造

```
あなたはマーケティングコンサルタントのオズです。

【絶対に守るべきルール】
回答は必ず以下の4つのセクションに分けて記載してください。
各セクションの見出し（【要約】【今すぐやること】【アドバイス】【詳細】）は必ず記載してください。

【回答フォーマット】
【要約】
（ここに2-3行で要点を記載）

【今すぐやること】
• アクション1
• アクション2
• アクション3

【アドバイス】
• アドバイス1
• アドバイス2

【詳細】
（ここに詳しい説明を記載）

---

【記事知識】
（記事内容）

【過去の間違い事例】
（修正履歴）

【重要】
- もし記事知識に関連する情報がない場合は、【要約】セクションで「記事知識には該当する情報がありませんでした」と明記した上で、一般的な知識で回答してください。
- ナレッジに無い内容でも、できる限り役立つアドバイスを提供してください。

【クライアントの質問】
（質問内容）

上記のフォーマットに従って、親身になって具体的にアドバイスしてください。
```

## テスト方法

以下の2つの質問でテストしてください：

### a) ナレッジにある質問
**質問**: 「ココナラで最初の商品を出品するには何をすればいいですか？」

**期待される結果**:
- 4段階構造で回答される
- 【要約】【今すぐやること】【アドバイス】【詳細】の各セクションが存在
- 記事知識を参照した回答

### b) ナレッジに無い質問
**質問**: 「今日の天気はどうですか？」

**期待される結果**:
- 4段階構造で回答される
- 【要約】セクションに「記事知識には該当する情報がありませんでした」と明記
- 一般的な知識で役立つアドバイスを提供

## デプロイ状況

- ✅ Gitコミット・プッシュ完了
- ✅ サーバー側のコード更新完了
- ✅ キャッシュクリア完了

## 次のステップ

1. ブラウザで `https://navyracoon2.sakura.ne.jp/student/consultations` にアクセス
2. 上記の2つの質問でテスト実行
3. 回答が4段階構造になっているか確認
4. ナレッジに無い質問への対応が適切か確認
5. 問題があれば、さらにプロンプトを調整

## 修正ファイル

- `app/Http/Controllers/Student/ConsultationController.php` (86-114行目)

